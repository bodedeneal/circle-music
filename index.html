<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Perfect Bounce Gravity Ball + Trail</title>
<style>
html,body {margin:0;padding:0;background:#fff;color:#111;font-family:sans-serif;}
.wrap {max-width:900px;margin:20px auto;padding:0 16px;}
canvas {width:100%;height:65vh;min-height:360px;background:#fff;border:1px solid #eee;border-radius:8px;}
.controls {display:flex;gap:12px;align-items:center;margin-bottom:12px;}
.status {font-size:13px;color:#555;}
.spacer {flex:1;}
</style>
</head>
<body>
<div class="wrap">
<h1>Perfect Bounce Gravity Ball + Trail</h1>
<div class="controls">
<input id="file" type="file" accept="audio/*"/>
<span id="fileStatus" class="status">No file loaded</span>
<div class="spacer"></div>
<button id="startStop">Start</button>
<button id="reset">Reset</button>
</div>
<canvas id="canvas"></canvas>
</div>

<audio id="player" preload="auto" style="display:none"></audio>

<script>
const GROW_DURATION_SEC=30;
const BALL_RADIUS_START=10;
const BALL_RADIUS_END=120;
const SPEED_INIT=250;
const GRAVITY=500; // px/sÂ² downward
const BORDER_MARGIN=24;
const ELASTICITY=1.3; // perfect bounce
const MUSIC_DELAY_SEC=0.2;
const TRAIL_LENGTH=25;

const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const startBtn=document.getElementById('startStop');
const resetBtn=document.getElementById('reset');
const fileInput=document.getElementById('file');
const fileStatus=document.getElementById('fileStatus');
const audioEl=document.getElementById('player');

let centerX=0,centerY=0,arenaR=0;
let x=0,y=0,vx=0,vy=0,r=BALL_RADIUS_START;
let running=false,startedAt=0,prevT=0,rafId=0;
let inContact=false,firstCollision=false,musicStopScheduled=false;
let scheduledStopId=0,audioLoaded=false,objectUrl=null;
let trail=[];

function resizeCanvas(){
  const rect=canvas.getBoundingClientRect();
  const dpr=Math.max(1,window.devicePixelRatio||1);
  canvas.width=Math.floor(rect.width*dpr);
  canvas.height=Math.floor(rect.height*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  centerX=canvas.clientWidth/2;
  centerY=canvas.clientHeight/2;
  arenaR=Math.max(40,Math.min(centerX,centerY)-BORDER_MARGIN);
}
window.addEventListener('resize',resizeCanvas,{passive:true});

function resetBall(angle=-Math.PI/4){
  x=centerX;y=centerY;
  vx=Math.cos(angle)*SPEED_INIT;
  vy=Math.sin(angle)*SPEED_INIT;
  r=BALL_RADIUS_START;
  inContact=false;firstCollision=false;musicStopScheduled=false;
  trail=[];
}

function resetAll(){
  cancelAnimationFrame(rafId);
  running=false;
  startBtn.textContent='Start';
  startedAt=0;prevT=0;
  if(!audioEl.paused) audioEl.pause();
  if(audioLoaded) audioEl.currentTime=0;
  if(scheduledStopId) clearTimeout(scheduledStopId);
  resizeCanvas();
  resetBall();
  draw(0);
}

fileInput.addEventListener('change',()=>{
  const f=fileInput.files&&fileInput.files[0];
  if(!f){
    fileStatus.textContent='No file loaded';
    audioLoaded=false;
    if(objectUrl) URL.revokeObjectURL(objectUrl);
    objectUrl=null;
    audioEl.removeAttribute('src');
    return;
  }
  if(objectUrl) URL.revokeObjectURL(objectUrl);
  objectUrl=URL.createObjectURL(f);
  audioEl.src=objectUrl;
  audioEl.load();
  audioLoaded=true;
  fileStatus.textContent=`Loaded: ${f.name}`;
});

startBtn.addEventListener('click',async()=>{
  if(!running){
    running=true;
    startBtn.textContent='Pause';
    if(!startedAt){startedAt=performance.now();}
    else {startedAt += performance.now()-prevT;}
    prevT=performance.now();
    if(audioLoaded && audioEl.paused){try{await audioEl.play();}catch{}}
    rafId=requestAnimationFrame(loop);
  }else{
    running=false;
    startBtn.textContent='Resume';
    cancelAnimationFrame(rafId);
    prevT=performance.now();
    if(!audioEl.paused) audioEl.pause();
  }
});

resetBtn.addEventListener('click',resetAll);

function reflectVelocity(vx,vy,nx,ny){
  const dot=vx*nx+vy*ny;
  let rx=vx-2*dot*nx;
  let ry=vy-2*dot*ny;
  return [rx*ELASTICITY,ry*ELASTICITY];
}

function loop(now){
  const dt=Math.max(0,(now-prevT)/1000);
  prevT=now;
  const elapsed=(now-startedAt)/1000;
  const g=Math.min(1,elapsed/GROW_DURATION_SEC);
  r=BALL_RADIUS_START+(BALL_RADIUS_END-BALL_RADIUS_START)*g;

  vy+=GRAVITY*dt; // constant gravity downward

  // store trail
  trail.push({x,y,r});
  if(trail.length>TRAIL_LENGTH) trail.shift();

  x+=vx*dt;
  y+=vy*dt;

  const dx=x-centerX;
  const dy=y-centerY;
  const dist=Math.hypot(dx,dy);
  const limit=Math.max(0,arenaR-r);

  if(dist>=limit-0.0001){
    const nx=dx/dist;
    const ny=dy/dist;
    x=centerX+nx*limit;
    y=centerY+ny*limit;
    const vn=vx*nx+vy*ny;
    if(vn>0){[vx,vy]=reflectVelocity(vx,vy,nx,ny);}
    if(!inContact){
      inContact=true;
      handleCollisionEvent();
    }
  } else {inContact=false;}

  draw();
  if(running) rafId=requestAnimationFrame(loop);
}

function handleCollisionEvent(){
  if(!firstCollision){firstCollision=true;return;}
  if(!musicStopScheduled){
    musicStopScheduled=true;
    scheduledStopId=setTimeout(()=>{
      if(!audioEl.paused) audioEl.pause();
    },MUSIC_DELAY_SEC*1000);
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
  // arena
  ctx.save();
  ctx.translate(centerX,centerY);
  ctx.beginPath();
  ctx.arc(0,0,arenaR,0,Math.PI*2);
  ctx.strokeStyle='#000';
  ctx.lineWidth=2;
  ctx.stroke();
  ctx.restore();

  // trail
  for(let i=0;i<trail.length;i++){
    const p=trail[i];
    const alpha=i/trail.length;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fillStyle=`rgba(0,0,0,${alpha*0.4})`;
    ctx.fill();
  }
  // ball
  ctx.beginPath();
  ctx.arc(x,y,r,0,Math.PI*2);
  ctx.fillStyle='#000';
  ctx.fill();
}

resizeCanvas();
resetBall();
draw(0);
</script>
</body>
</html>
